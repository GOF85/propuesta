<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administraci√≥n - Platos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50" style="font-family: 'Inter', sans-serif;">

<%- include('../partials/header') %>

<main class="max-w-6xl mx-auto px-6 py-8">

    <%- include('../partials/flash-messages') %>

    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">üçΩÔ∏è Administraci√≥n - Platos</h1>
        <p class="text-gray-500 mt-2">Gestiona el cat√°logo maestro de platos (importa, exporta, edita)</p>
    </div>

    <!-- Tabs -->
    <div class="border-b border-gray-200 mb-8 flex gap-6">
        <button class="py-2 px-0 border-b-2 border-blue-600 text-blue-600 font-medium" onclick="showTab('list')">
            üìã Lista
        </button>
        <button class="py-2 px-0 border-b border-gray-200 text-gray-600 hover:text-gray-900 font-medium" onclick="showTab('import')">
            üì• Importar CSV
        </button>
        <button class="py-2 px-0 border-b border-gray-200 text-gray-600 hover:text-gray-900 font-medium" onclick="showTab('template')">
            üìÑ Descargar CSV
        </button>
    </div>

    <!-- TAB 1: LISTA DE PLATOS -->
    <div id="tab-list" class="tab-content">
        <div class="flex justify-between items-center mb-6">
            <div>
                <p class="text-gray-600">Total: <strong><%= totalDishes %> platos</strong></p>
            </div>
            <a href="/admin/dishes/export" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                ‚¨áÔ∏è Exportar CSV
            </a>
        </div>

        <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
            <% if (dishes.length === 0) { %>
                <div class="p-12 text-center text-gray-500">
                    <p class="mb-4">No hay platos. Importa algunos desde "Importar JSON".</p>
                </div>
            <% } else { %>
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-left font-semibold text-gray-700">Nombre</th>
                            <th class="px-6 py-3 text-left font-semibold text-gray-700">Categor√≠a</th>
                            <th class="px-6 py-3 text-left font-semibold text-gray-700">Descripci√≥n</th>
                            <th class="px-6 py-3 text-center font-semibold text-gray-700">Precio Base</th>
                            <th class="px-6 py-3 text-left font-semibold text-gray-700">Al√©rgenos</th>
                            <th class="px-6 py-3 text-center font-semibold text-gray-700">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <% dishes.forEach(dish => { %>
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4">
                                <div class="font-medium text-gray-900"><%= dish.name %></div>
                            </td>
                            <td class="px-6 py-4 text-sm">
                                <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs font-medium">
                                    <%= dish.category %>
                                </span>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-600">
                                <%= dish.description ? dish.description.substring(0, 40) + '...' : '' %>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="font-bold text-gray-900"><%= dish.base_price %>‚Ç¨</span>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-600">
                                <% 
                                  const allergens = typeof dish.allergens === 'string' ? JSON.parse(dish.allergens) : dish.allergens;
                                  const allergenList = Array.isArray(allergens) ? allergens.join(', ') : '';
                                %>
                                <%= allergenList ? allergenList.substring(0, 30) : '--' %>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <form method="POST" action="/admin/dishes/<%= dish.id %>/delete" style="display: inline;">
                                    <button type="submit" class="text-red-600 hover:text-red-700 font-medium text-sm"
                                            onclick="return confirm('¬øEliminar <%= dish.name %>?')">
                                        üóëÔ∏è Eliminar
                                    </button>
                                </form>
                            </td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            <% } %>
        </div>
    </div>

    <!-- TAB 2: IMPORTAR CSV -->
    <div id="tab-import" class="tab-content hidden">
        <div class="bg-white rounded-lg border border-gray-200 p-8">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Importar Platos desde CSV</h2>
            
            <form id="import-form" method="POST" action="/admin/dishes/import" enctype="multipart/form-data">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">üìÅ Archivo CSV</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 cursor-pointer transition"
                         id="dropzone" onclick="document.getElementById('csvFile').click()">
                        <input type="file" id="csvFile" name="csvFile" accept=".csv" class="hidden" required>
                        <p class="text-gray-600 font-medium">Arrastra un CSV aqu√≠ o haz clic para seleccionar</p>
                        <p class="text-sm text-gray-500 mt-1">Formato: CSV con encabezados</p>
                        <p id="file-name" class="text-blue-600 font-medium mt-2"></p>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                        ‚úÖ Importar
                    </button>
                </div>

                <div id="import-result" class="mt-6 hidden"></div>
            </form>
        </div>
    </div>

    <!-- TAB 3: PLANTILLA -->
    <div id="tab-template" class="tab-content hidden">
        <div class="bg-white rounded-lg border border-gray-200 p-8">
            <h2 class="text-xl font-bold text-gray-900 mb-4">üì• Descargar Plantilla CSV de Platos</h2>
            <p class="text-gray-600 mb-4">Descarga este archivo CSV, ed√≠talo en Excel o Google Sheets, y luego imp√≥rtalo:</p>

            <pre class="bg-gray-50 border border-gray-200 rounded-lg p-4 overflow-x-auto text-sm"><code id="template-code">name,description,category,allergens,badges,image_url,base_price
"Ensalada C√©sar","Lechuga romana, croutons, parmesano, salsa C√©sar casera","entrante","gluten|lacteos|huevo","","/uploads/dishes/ensalada-cesar.webp",8.50
"Solomillo de Ternera","Corte premium con salsa de champi√±ones","principal","","","/uploads/dishes/solomillo.webp",28.00
"Tarta de Queso NY","Cl√°sica receta neoyorquina","postre","lacteos|huevo","sin gluten","/uploads/dishes/tarta-queso.webp",6.50</code></pre>

            <div class="flex gap-3 mt-6">
                <button id="copy-template" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg font-medium">
                    üìã Copiar Plantilla
                </button>
                <a id="download-template" href="#" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium inline-block">
                    ‚¨áÔ∏è Descargar CSV
                </a>
            </div>

            <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-sm text-blue-900">
                    <strong>üìù Columnas:</strong> name (requerido), description, category, allergens (separados por |), badges (separados por |), image_url, base_price
                </p>
            </div>
        </div>
    </div>

</main>

<%- include('../partials/footer') %>

<script>
function showTab(tab) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
    document.getElementById(`tab-${tab}`).classList.remove('hidden');
    
    document.querySelectorAll('[onclick^="showTab"]').forEach(b => {
        b.classList.remove('border-b-2', 'border-blue-600', 'text-blue-600');
        b.classList.add('border-b', 'border-gray-200', 'text-gray-600');
    });
    event.target.classList.remove('border-b', 'border-gray-200', 'text-gray-600');
    event.target.classList.add('border-b-2', 'border-blue-600', 'text-blue-600');
}

// Drag & drop + file select
const dropzone = document.getElementById('dropzone');
const csvFile = document.getElementById('csvFile');

dropzone?.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropzone.classList.add('border-blue-500', 'bg-blue-50');
});

dropzone?.addEventListener('dragleave', () => {
    dropzone.classList.remove('border-blue-500', 'bg-blue-50');
});

dropzone?.addEventListener('drop', (e) => {
    e.preventDefault();
    dropzone.classList.remove('border-blue-500', 'bg-blue-50');
    if (e.dataTransfer.files[0]) {
        csvFile.files = e.dataTransfer.files;
        updateFileName();
    }
});

csvFile?.addEventListener('change', updateFileName);

function updateFileName() {
    const name = csvFile.files[0]?.name;
    if (name) {
        document.getElementById('file-name').textContent = `üìÑ ${name}`;
    }
}

// Copiar plantilla
document.getElementById('copy-template')?.addEventListener('click', () => {
    const code = document.getElementById('template-code').textContent;
    navigator.clipboard.writeText(code).then(() => {
        alert('‚úÖ CSV copiado. P√©galo en un archivo .csv');
    });
});

// Descargar plantilla
document.getElementById('download-template')?.addEventListener('click', (e) => {
    e.preventDefault();
    const csv = `name,description,category,allergens,badges,image_url,base_price
"Ensalada C√©sar","Lechuga romana, croutons, parmesano, salsa C√©sar casera","entrante","gluten|lacteos|huevo","","/uploads/dishes/ensalada-cesar.webp",8.50
"Solomillo de Ternera","Corte premium con salsa de champi√±ones","principal","","","/uploads/dishes/solomillo.webp",28.00
"Tarta de Queso NY","Cl√°sica receta neoyorquina","postre","lacteos|huevo","sin gluten","/uploads/dishes/tarta-queso.webp",6.50`;
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'dishes-template.csv';
    a.click();
});

// Procesar importaci√≥n
document.getElementById('import-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData();
    formData.append('csvFile', csvFile.files[0]);
    
    try {
        const response = await fetch('/admin/dishes/import', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        
        if (result.success) {
            showResult(`
                <div class="bg-green-50 border border-green-200 rounded p-4">
                    <h3 class="font-bold text-green-900 mb-2">‚úÖ Importaci√≥n exitosa</h3>
                    <p class="text-green-700 text-sm mb-1"><strong>${result.inserted}</strong> nuevos platos</p>
                    <p class="text-green-700 text-sm"><strong>${result.updated}</strong> actualizados</p>
                </div>
                <button type="button" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded" onclick="location.reload()">
                    Recargar p√°gina
                </button>
            `);
        } else {
            showResult(`
                <div class="bg-red-50 border border-red-200 rounded p-4">
                    <h3 class="font-bold text-red-900">‚ùå Error</h3>
                    <p class="text-red-700 text-sm">${result.error}</p>
                </div>
            `);
        }
    } catch (err) {
        showResult(`
            <div class="bg-red-50 border border-red-200 rounded p-4">
                <h3 class="font-bold text-red-900">‚ùå Error</h3>
                <p class="text-red-700 text-sm">${err.message}</p>
            </div>
        `);
    }
});

function showResult(html) {
    const resultDiv = document.getElementById('import-result');
    resultDiv.innerHTML = html;
    resultDiv.classList.remove('hidden');
}
</script>

</body>
</html>
