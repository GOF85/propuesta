<%- include('../partials/header-client') %>

<!-- üé® INYECCI√ìN DIN√ÅMICA DE BRANDING -->
<style>
  :root {
    /* Colores din√°micos generados desde logo */
    --brand-primary: <%= brandPalette.primary %>;
    --brand-primary-rgb: <%= brandPalette.primaryRgb %>;
    --brand-hover: <%= brandPalette.hover %>;
    --brand-light: <%= brandPalette.light %>;
    --brand-dark: <%= brandPalette.dark %>;
    --brand-text: <%= brandPalette.text %>;
    --brand-complement: <%= brandPalette.complement %>;
  }

  /* Aplicar branding din√°mico */
  .brand-bg { background-color: var(--brand-primary) !important; }
  .brand-bg-light { background-color: var(--brand-light) !important; }
  .brand-text { color: var(--brand-primary) !important; }
  .brand-border { border-color: var(--brand-primary) !important; }
  .brand-hover:hover { background-color: var(--brand-hover) !important; }
  
  /* Botones con marca */
  .btn-brand {
    background-color: var(--brand-primary);
    color: var(--brand-text);
    border: none;
  }
  .btn-brand:hover {
    background-color: var(--brand-hover);
  }
</style>

<main class="min-h-screen bg-gradient-to-br from-gray-50 via-white to-gray-50 py-12">
  <div class="max-w-7xl mx-auto px-6">

    <!-- Hero Header Section -->
    <div class="mb-12 bg-white rounded-2xl border border-gray-200 shadow-sm p-10 overflow-hidden relative">
      <!-- Gradient accent -->
      <div class="absolute top-0 right-0 w-72 h-72 bg-blue-50 rounded-full -mr-36 -mt-36"></div>
      
      <div class="relative grid grid-cols-1 md:grid-cols-3 gap-8 items-start">
        <!-- Client Info -->
        <div class="col-span-2">
          <% if (proposal.logo_url) { %>
            <img src="<%= proposal.logo_url %>" alt="<%= proposal.client_name %>" class="h-16 mb-6 object-contain opacity-90 hover:opacity-100 transition">
          <% } %>
          <h1 class="text-4xl font-bold text-gray-900 mb-3">
            <%= proposal.client_name %>
          </h1>
          <div class="flex flex-col md:flex-row md:items-center gap-6 text-gray-600">
            <div class="flex items-center gap-2">
              <span class="text-xl">üìã</span>
              <div>
                <p class="text-xs text-gray-500">Propuesta N¬∫</p>
                <p class="font-semibold text-gray-900">#<%= proposal.id %></p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xl">üìÖ</span>
              <div>
                <p class="text-xs text-gray-500">Fecha del Evento</p>
                <p class="font-semibold text-gray-900"><%= formatDate(proposal.event_date) %></p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xl">üë•</span>
              <div>
                <p class="text-xs text-gray-500">Comensales</p>
                <p class="font-semibold text-gray-900"><%= proposal.pax %> PAX</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Summary Badge -->
        <div class="col-span-1">
          <div class="brand-bg text-white rounded-2xl p-8 shadow-lg text-center">
            <p class="text-sm font-medium opacity-90 mb-2">Presupuesto Personalizado</p>
            <p class="text-4xl font-bold mb-2"><%= proposal.pax %></p>
            <p class="text-sm opacity-90">Personas</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

      <!-- Primary Content (2/3) -->
      <div class="lg:col-span-2 space-y-8">

        <!-- Event Information Card -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">üìã Informaci√≥n del Evento</h2>
            <span class="badge badge-info">DETALLES</span>
          </div>

          <div class="grid grid-cols-2 gap-6">
            <div class="space-y-1">
              <p class="text-xs font-semibold text-gray-500 uppercase">Fecha</p>
              <p class="text-lg font-bold text-gray-900"><%= formatDate(proposal.event_date) %></p>
            </div>
            <div class="space-y-1">
              <p class="text-xs font-semibold text-gray-500 uppercase">Comensales</p>
              <p class="text-lg font-bold text-gray-900"><%= proposal.pax %> personas</p>
            </div>
          </div>

          <% if (proposal.legal_conditions) { %>
            <div class="mt-6 pt-6 border-t border-gray-200">
              <p class="text-xs font-semibold text-gray-500 uppercase mb-3">Condiciones Legales</p>
              <p class="text-gray-700 leading-relaxed whitespace-pre-wrap text-sm">
                <%= proposal.legal_conditions %>
              </p>
            </div>
          <% } %>

          <div class="mt-6 pt-6 border-t border-gray-200 flex items-center justify-between">
            <p class="text-xs text-gray-500">Propuesta v√°lida hasta:</p>
            <p class="font-semibold text-gray-900"><%= formatDate(proposal.valid_until) %></p>
          </div>
        </div>

        <!-- Venues Section -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">üè¢ Venues</h2>
            <% if (proposal.venues && proposal.venues.length > 0) { %>
              <span class="badge badge-success"><%= proposal.venues.length %> Venue(s)</span>
            <% } %>
          </div>

          <% if (proposal.venues && proposal.venues.length > 0) { %>
            <div class="space-y-4">
              <% proposal.venues.forEach((venue, idx) => { %>
                <div class="border border-gray-200 rounded-lg p-5 hover:bg-gray-50 hover:border-gray-300 transition">
                  <div class="flex items-start gap-3">
                    <div class="text-2xl">üè¢</div>
                    <div class="flex-1">
                      <h3 class="font-bold text-gray-900"><%= venue.name %></h3>
                      <p class="text-sm text-gray-600 mt-1"><%= venue.description || 'Sin descripci√≥n disponible' %></p>
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>
          <% } else { %>
            <div class="text-center py-8">
              <p class="text-gray-500">No hay venues especificados para esta propuesta</p>
            </div>
          <% } %>
        </div>

        <!-- Services & Pricing Section -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">üçΩÔ∏è Servicios y Precios</h2>
            <% if (proposal.services && proposal.services.length > 0) { %>
              <span class="badge badge-warning"><%= proposal.services.length %> Servicio(s)</span>
            <% } %>
          </div>

          <% if (proposal.services && proposal.services.length > 0) { %>
            <div class="overflow-x-auto">
              <table class="table">
                <thead>
                  <tr>
                    <th>Servicio</th>
                    <th class="text-center">Por PAX</th>
                    <th class="text-right">Subtotal</th>
                    <th class="text-right">IVA</th>
                  </tr>
                </thead>
                <tbody>
                  <% proposal.services.forEach(service => { %>
                    <tr class="hover:bg-blue-50">
                      <td class="font-semibold"><%= service.title %></td>
                      <td class="text-center"><%= formatCurrency(service.price_per_pax || 0) %></td>
                      <td class="text-right"><%= formatCurrency((service.price_per_pax || 0) * proposal.pax) %></td>
                      <td class="text-right">
                        <span class="text-blue-600 font-medium">
                          <%= formatCurrency(((service.price_per_pax || 0) * proposal.pax) * (service.vat_rate || 0.10) / 100) %>
                        </span>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <div class="text-center py-8">
              <p class="text-gray-500">No hay servicios especificados</p>
            </div>
          <% } %>
        </div>

      </div>

      <!-- Sidebar (1/3) -->
      <div class="lg:col-span-1">

        <!-- Budget Summary (Sticky) -->
        <div class="card sticky top-6 bg-gradient-to-br from-blue-50 to-indigo-50 border-blue-200">
          <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2">
            üí∞ Presupuesto Total
          </h3>

          <div class="space-y-4">
            <div class="flex justify-between items-center text-sm">
              <span class="text-gray-600">Subtotal:</span>
              <span class="font-semibold text-gray-900"><%= formatCurrency(proposal.total_base || 0) %></span>
            </div>

            <div class="flex justify-between items-center text-sm">
              <span class="text-gray-600">IVA (10-21%):</span>
              <span class="font-semibold text-gray-900"><%= formatCurrency((proposal.total_estimated - proposal.total_base) || 0) %></span>
            </div>

            <div class="border-t-2 border-b-2 border-blue-200 py-4 my-4">
              <div class="flex justify-between items-center">
                <span class="font-bold text-gray-900 text-lg">Total:</span>
                <span class="text-3xl font-bold text-blue-600">
                  <%= formatCurrency(proposal.total_estimated || 0) %>
                </span>
              </div>
            </div>

            <p class="text-xs text-gray-600 leading-relaxed">
              ‚úì Presupuesto v√°lido hasta <br>
              <strong><%= formatDate(proposal.valid_until) %></strong>
            </p>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-8 space-y-3">
          <button id="btn-accept" class="btn btn-primary w-full btn-lg flex items-center justify-center gap-2">
            <span>‚úÖ</span> Aceptar Propuesta
          </button>

          <button id="btn-modifications" class="btn btn-outline w-full flex items-center justify-center gap-2">
            <span>üîÑ</span> Solicitar Cambios
          </button>

          <button id="btn-reject" class="btn btn-outline w-full flex items-center justify-center gap-2">
            <span>‚ùå</span> Rechazar
          </button>

          <button onclick="window.print()" class="btn btn-secondary w-full flex items-center justify-center gap-2 text-gray-700">
            <span>üñ®Ô∏è</span> Imprimir
          </button>
        </div>

        <!-- Help Section -->
        <div class="mt-8 bg-blue-50 rounded-lg border border-blue-200 p-6">
          <h4 class="font-bold text-gray-900 mb-3 flex items-center gap-2">
            <span>‚ÑπÔ∏è</span> ¬øNecesitas Ayuda?
          </h4>
          <p class="text-sm text-gray-700 leading-relaxed">
            Si tienes preguntas o necesitas aclaraciones, usa el chat para contactar con tu comercial. Estamos aqu√≠ para ayudarte.
          </p>
        </div>

      </div>

    </div>

  </div>
</main>

<!-- Modal Mejorado: Solicitar Modificaciones -->
<div id="modal-modifications" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full transform transition-all">
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-8 py-6 border-b border-gray-200">
      <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
        <span>üîÑ</span> Solicitar Modificaciones
      </h2>
      <p class="text-sm text-gray-600 mt-1">Cu√©ntanos qu√© cambios deseas</p>
    </div>
    
    <div class="p-8 space-y-6">
      <textarea id="modifications-text" 
        placeholder="Describe detalladamente los cambios que deseas..."
        rows="5"
        class="form-input w-full border border-gray-300 rounded-lg p-4 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition resize-none"></textarea>

      <div class="flex gap-3">
        <button id="btn-cancel-modifications" class="btn btn-outline flex-1">Cancelar</button>
        <button id="btn-send-modifications" class="btn btn-primary flex-1">Enviar Solicitud</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Mejorado: Rechazar -->
<div id="modal-reject" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full transform transition-all">
    <div class="bg-gradient-to-r from-red-50 to-orange-50 px-8 py-6 border-b border-gray-200">
      <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
        <span>‚ùå</span> Rechazar Propuesta
      </h2>
      <p class="text-sm text-gray-600 mt-1">Esta acci√≥n no se puede deshacer</p>
    </div>
    
    <div class="p-8 space-y-6">
      <p class="text-gray-700">¬øEst√°s seguro de que deseas rechazar esta propuesta?</p>
      
      <textarea id="reject-reason" 
        placeholder="(Opcional) Expl√≠canos el motivo del rechazo..."
        rows="4"
        class="form-input w-full border border-gray-300 rounded-lg p-4 focus:border-red-500 focus:ring-2 focus:ring-red-200 transition resize-none"></textarea>

      <div class="flex gap-3">
        <button id="btn-cancel-reject" class="btn btn-outline flex-1">Cancelar</button>
        <button id="btn-confirm-reject" class="btn w-full flex-1" style="background-color: #dc2626; color: white;">Confirmar Rechazo</button>
      </div>
    </div>
  </div>
</div>

<!-- Professional Styles -->
<style>
  .form-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    font-family: inherit;
    font-size: 0.875rem;
    transition: all 150ms ease;
  }

  .form-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: 0.75rem;
    font-weight: 600;
    font-size: 0.875rem;
    transition: all 150ms ease;
    cursor: pointer;
    text-decoration: none;
    border: 1px solid transparent;
  }

  .btn-primary {
    background-color: #3b82f6;
    color: white;
    box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
  }

  .btn-primary:hover {
    background-color: #2563eb;
    box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
    transform: translateY(-2px);
  }

  .btn-secondary {
    background-color: #e5e7eb;
    color: #1f2937;
  }

  .btn-secondary:hover {
    background-color: #d1d5db;
  }

  .btn-outline {
    border: 2px solid #d1d5db;
    color: #374151;
    background-color: transparent;
  }

  .btn-outline:hover {
    background-color: #f9fafb;
    border-color: #9ca3af;
  }

  .btn-lg {
    padding: 1rem 1.5rem;
    font-size: 1rem;
  }

  @media print {
    .btn, nav, .sticky, button, #btn-accept, #btn-modifications, #btn-reject {
      display: none !important;
    }
    
    #modal-modifications, #modal-reject {
      display: none !important;
    }
  }
</style>

<!-- Script de cliente -->
<script src="/js/client-proposal.js" defer></script>

<%- include('../partials/footer') %>
