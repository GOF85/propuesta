<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MICE CATERING</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            nav, footer, button, .print-hidden { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-50">

<%- include('../partials/header') %>

<main class="max-w-7xl mx-auto px-6 py-8">
    
    <!-- Flash Messages -->
    <%- include('../partials/flash-messages') %>

    <!-- Header con T√≠tulo y Bot√≥n Nueva Propuesta -->
    <div class="flex justify-between items-end mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Mis Propuestas</h1>
            <p class="text-gray-500 text-sm mt-1">Gestiona tus eventos y comparte con clientes</p>
        </div>
        <a href="/proposal/new" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg shadow-sm font-medium flex items-center gap-2 transition-colors print-hidden">
            <span>+</span> Nueva Propuesta
        </a>
    </div>

    <!-- Filtros -->
    <div class="mb-6 flex flex-col md:flex-row gap-4 items-center border-b border-gray-200 pb-4">
        <!-- Filtros por Estado -->
        <div class="flex gap-1 border-b-2 border-gray-200 -mb-4">
            <a href="?status=all" class="px-4 py-2 font-medium text-sm <%= currentFilter === 'all' ? 'text-blue-600 border-b-2 border-blue-600 -mb-0' : 'text-gray-500 hover:text-gray-700' %>">
                Todas
            </a>
            <a href="?status=draft" class="px-4 py-2 font-medium text-sm <%= currentFilter === 'draft' ? 'text-blue-600 border-b-2 border-blue-600 -mb-0' : 'text-gray-500 hover:text-gray-700' %>">
                Borradores
            </a>
            <a href="?status=sent" class="px-4 py-2 font-medium text-sm <%= currentFilter === 'sent' ? 'text-blue-600 border-b-2 border-blue-600 -mb-0' : 'text-gray-500 hover:text-gray-700' %>">
                Enviadas
            </a>
            <a href="?status=accepted" class="px-4 py-2 font-medium text-sm <%= currentFilter === 'accepted' ? 'text-blue-600 border-b-2 border-blue-600 -mb-0' : 'text-gray-500 hover:text-gray-700' %>">
                Aceptadas
            </a>
            <a href="?status=cancelled" class="px-4 py-2 font-medium text-sm <%= currentFilter === 'cancelled' ? 'text-red-600 border-b-2 border-red-600 -mb-0' : 'text-gray-500 hover:text-red-600' %>">
                Anuladas
            </a>
        </div>

        <!-- Search (AJAX) -->
        <div class="ml-auto flex gap-2">
            <input 
                type="text" 
                id="searchInput"
                placeholder="Buscar cliente, venue..." 
                value="<%= searchTerm %>"
                class="pl-4 pr-4 py-2 border rounded-lg text-sm w-64 focus:ring-2 focus:ring-blue-500 focus:outline-none transition-colors"
            >
            <div id="searchLoading" class="px-4 py-2 flex items-center gap-2 text-gray-400 hidden">
                <span class="inline-block animate-spin">‚ü≥</span>
            </div>
        </div>
    </div>

    <!-- Tabla de Propuestas -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <% if (proposals.length === 0) { %>
            <!-- Empty State -->
            <div class="p-12 text-center">
                <div class="text-5xl mb-4">üìã</div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">No hay propuestas</h3>
                <p class="text-gray-500 mb-6">
                    <% if (searchTerm) { %>
                        No se encontraron resultados para "<%= searchTerm %>"
                    <% } else if (currentFilter !== 'all') { %>
                        No tienes propuestas con estado <%= statusLabel(currentFilter) %>
                    <% } else { %>
                        Crea tu primera propuesta para empezar
                    <% } %>
                </p>
                <a href="/proposal/new" class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                    + Crear Propuesta
                </a>
            </div>
        <% } else { %>
            <!-- Table -->
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider">Cliente / Evento</th>
                            <th class="px-6 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider">Fecha Evento</th>
                            <th class="px-6 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider">Venue</th>
                            <th class="px-6 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider text-right">Importe Est.</th>
                            <th class="px-6 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider text-center">Estado</th>
                            <th class="px-6 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <% proposals.forEach(p => { %>
                        <tr class="hover:bg-gray-50 transition-colors group <%= p.status === 'cancelled' ? 'bg-red-50/40' : '' %>">
                            <!-- Cliente / Evento -->
                            <td class="px-6 py-4">
                                <div class="font-bold <%= p.status === 'cancelled' ? 'text-red-800 line-through' : 'text-gray-900' %>"><%= p.client_name %></div>
                            </td>

                            <!-- Fecha Evento -->
                            <td class="px-6 py-4 text-sm <%= p.status === 'cancelled' ? 'text-red-700/70' : 'text-gray-600' %>">
                                <div><%= p.formattedDate %></div>
                                <div class="text-xs mt-1 <%= p.status === 'cancelled' ? 'text-red-600/60' : 'text-gray-400' %>"><%= p.pax %> Pax</div>
                            </td>

                            <!-- Venue -->
                            <td class="px-6 py-4 text-sm <%= p.status === 'cancelled' ? 'text-red-700/70' : 'text-gray-600' %>">
                                <% if (p.venue_names) { %>
                                    <%= p.venue_names %>
                                <% } else { %>
                                    <span class="inline-block bg-yellow-50 text-yellow-700 px-2 py-1 rounded text-xs border border-yellow-200">
                                        Sin venue definido
                                    </span>
                                <% } %>
                            </td>

                            <!-- Importe Estimado -->
                            <td class="px-6 py-4 text-right">
                                <div class="font-bold text-sm <%= p.status === 'cancelled' ? 'text-red-800' : 'text-gray-900' %>">
                                    <% if (p.total > 0) { %>
                                        <%= p.formattedTotal %>
                                    <% } else { %>
                                        <span class="text-gray-400">--</span>
                                    <% } %>
                                </div>
                            </td>

                            <!-- Estado -->
                            <td class="px-6 py-4 text-center">
                                <div class="inline-block">
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold border
                                        <% if (p.status === 'draft') { %>
                                            bg-gray-100 text-gray-700 border-gray-200
                                        <% } else if (p.status === 'sent') { %>
                                            bg-yellow-100 text-yellow-700 border-yellow-200
                                        <% } else if (p.status === 'accepted') { %>
                                            bg-green-100 text-green-700 border-green-200
                                        <% } else if (p.status === 'cancelled') { %>
                                            bg-red-100 text-red-700 border-red-200
                                        <% } %>
                                    ">
                                        <%= p.statusLabel %>
                                    </span>
                                </div>
                            </td>

                            <!-- Acciones -->
                            <td class="px-6 py-4 text-right">
                                <% if (p.status === 'cancelled') { %>
                                    <div class="flex justify-end gap-2 items-center print-hidden">
                                        <a href="/p/<%= p.unique_hash %>" 
                                           target="_blank"
                                           class="px-3 py-1.5 bg-emerald-50 text-emerald-700 hover:bg-emerald-100 rounded-lg text-xs font-semibold transition-colors border border-emerald-200 inline-flex items-center gap-1.5" 
                                           title="Ver propuesta como cliente (nueva ventana)">
                                            üëÅÔ∏è Ver
                                        </a>
                                        <span class="px-3 py-1 rounded-lg text-xs font-semibold border border-red-200 bg-red-50 text-red-700">
                                            Acciones deshabilitadas
                                        </span>
                                    </div>
                                <% } else { %>
                                    <div class="flex justify-end gap-2 items-center opacity-0 group-hover:opacity-100 transition-opacity print-hidden">
                                        <!-- Ver como Cliente (PRIMARY ACTION) -->
                                        <a href="/p/<%= p.unique_hash %>" 
                                           target="_blank"
                                           class="px-3 py-1.5 bg-emerald-50 text-emerald-700 hover:bg-emerald-100 rounded-lg text-xs font-semibold transition-colors border border-emerald-200 inline-flex items-center gap-1.5" 
                                           title="Ver propuesta como cliente (nueva ventana)">
                                            üëÅÔ∏è Ver
                                        </a>

                                        <!-- Men√∫ de acciones adicionales -->
                                        <div class="relative group/menu">
                                            <button class="text-gray-400 hover:text-gray-600 transition-colors text-lg" title="M√°s opciones">
                                                ‚ãÆ
                                            </button>
                                            <div class="absolute right-0 mt-1 w-48 bg-white border border-gray-200 rounded-lg shadow-lg hidden group-hover/menu:block opacity-0 group-hover/menu:opacity-100 transition-opacity z-50">
                                                <!-- Editar -->
                                                <a href="/proposal/<%= p.id %>/edit" 
                                                   class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 first:rounded-t-lg" 
                                                   title="Editar propuesta">
                                                    ‚úèÔ∏è Editar
                                                </a>

                                                <!-- Copiar hash -->
                                                <button onclick="copyToClipboard('/p/<%= p.unique_hash %>')"
                                                        class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50" 
                                                        title="Copiar enlace para compartir">
                                                    üîó Copiar enlace
                                                </button>

                                                <!-- Chat -->
                                                <a href="/proposal/<%= p.id %>/chat" 
                                                   class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-purple-50" 
                                                   title="Chat con cliente">
                                                    üí¨ Chat
                                                </a>

                                                <!-- Duplicar -->
                                                <form method="POST" action="/proposal/<%= p.id %>/duplicate" style="display: contents;">
                                                    <button type="submit" 
                                                            class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-green-50" 
                                                            title="Duplicar propuesta"
                                                            onclick="return confirm('¬øDuplicar esta propuesta?')">
                                                        üìã Duplicar
                                                    </button>
                                                </form>

                                                <!-- Eliminar -->
                                                <form method="POST" action="/proposal/<%= p.id %>/delete" style="display: contents;">
                                                    <button type="submit" 
                                                            class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 last:rounded-b-lg" 
                                                            title="Eliminar propuesta"
                                                            onclick="return confirm('¬øEst√°s seguro? Esta acci√≥n no se puede deshacer.')">
                                                        üóëÔ∏è Eliminar
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                <% } %>
                            </td>
                        </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>

            <!-- Pagination (future) -->
            <% if (pageNumber > 1 || proposals.length === 10) { %>
            <div class="px-6 py-4 border-t border-gray-200 flex justify-between items-center text-sm text-gray-600">
                <% if (pageNumber > 1) { %>
                    <a href="?status=<%= currentFilter %>&search=<%= searchTerm %>&page=<%= pageNumber - 1 %>" 
                       class="text-blue-600 hover:text-blue-700 font-medium">
                        ‚Üê Anterior
                    </a>
                <% } else { %>
                    <span></span>
                <% } %>
                
                <span>P√°gina <%= pageNumber %></span>
                
                <% if (proposals.length === 10) { %>
                    <a href="?status=<%= currentFilter %>&search=<%= searchTerm %>&page=<%= pageNumber + 1 %>" 
                       class="text-blue-600 hover:text-blue-700 font-medium">
                        Siguiente ‚Üí
                    </a>
                <% } else { %>
                    <span></span>
                <% } %>
            </div>
            <% } %>
        <% } %>
    </div>

    <!-- Stats (Optional) -->
    <div class="mt-8 grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="text-2xl font-bold text-gray-900"><%= proposals.filter(p => p.status === 'draft').length %></div>
            <div class="text-sm text-gray-500 mt-1">Borradores</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="text-2xl font-bold text-gray-900"><%= proposals.filter(p => p.status === 'sent').length %></div>
            <div class="text-sm text-gray-500 mt-1">Enviadas</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="text-2xl font-bold text-gray-900"><%= proposals.filter(p => p.status === 'accepted').length %></div>
            <div class="text-sm text-gray-500 mt-1">Aceptadas</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="text-2xl font-bold text-green-600">
                <%= (proposals.filter(p => p.status === 'accepted').reduce((sum, p) => sum + (p.total || 0), 0)).toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) %> ‚Ç¨
            </div>
            <div class="text-sm text-gray-500 mt-1">Ingresos Confirmados</div>
        </div>
    </div>

</main>

<%- include('../partials/footer') %>

<script src="/js/utils.js"></script>
<script src="/js/dashboard-search.js"></script>
<script>
// Copiar a portapapeles
function copyToClipboard(text) {
  const baseUrl = '<%= user?.domain || 'https://propuesta.micecatering.eu' %>';
  const fullUrl = baseUrl + text;
  
  navigator.clipboard.writeText(fullUrl).then(() => {
    // Show toast notification
    const toast = document.createElement('div');
    toast.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
    toast.textContent = '‚úÖ Enlace copiado: ' + fullUrl;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.remove();
    }, 3000);
  }).catch(err => {
    console.error('Error al copiar:', err);
    alert('No se pudo copiar el enlace. Intenta nuevamente.');
  });
}

// Manejo de formularios inline (duplicar, eliminar)
document.querySelectorAll('form').forEach(form => {
    if (form.method === 'POST') {
        form.addEventListener('submit', function(e) {
            // Las validaciones ya est√°n en los onclick de los botones
        });
    }
});
</script>

</body>
</html>
