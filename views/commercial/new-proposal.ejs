<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Propuesta - MICE CATERING</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">

<%- include('../partials/header') %>

<main class="max-w-4xl mx-auto px-6 py-8">
    
    <%- include('../partials/flash-messages') %>

    <!-- Header -->
    <div class="mb-8">
        <a href="/dashboard" class="text-blue-600 hover:text-blue-700 text-sm font-medium mb-4 inline-block">
            ‚Üê Volver al Dashboard
        </a>
        <h1 class="text-3xl font-bold text-gray-900">Nueva Propuesta</h1>
        <p class="text-gray-500 text-sm mt-1">Rellena los datos b√°sicos para crear una nueva propuesta</p>
    </div>

    <!-- Formulario -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
        <form method="POST" action="/proposal" id="proposalForm">
            <!-- Cliente -->
            <div class="mb-6">
                <label for="client_name" class="block text-sm font-semibold text-gray-900 mb-2">
                    Nombre del Cliente *
                </label>
                <input 
                    type="text" 
                    id="client_name" 
                    name="client_name"
                    placeholder="Ej: Amazon Web Services"
                    required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                >
                <p class="text-gray-500 text-xs mt-1">Requerido</p>
            </div>

            <!-- Grid: Fecha + Pax -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Fecha -->
                <div>
                    <label for="event_date" class="block text-sm font-semibold text-gray-900 mb-2">
                        Fecha del Evento
                    </label>
                    <input 
                        type="date" 
                        id="event_date" 
                        name="event_date"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                    >
                </div>

                <!-- Pax -->
                <div>
                    <label for="pax" class="block text-sm font-semibold text-gray-900 mb-2">
                        N√∫mero de Personas (Pax)
                    </label>
                    <input 
                        type="number" 
                        id="pax" 
                        name="pax"
                        placeholder="100"
                        min="0"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                    >
                </div>
            </div>

            <!-- Branding Section -->
            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h3 class="font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    üé® Branding Din√°mico (Opcional)
                </h3>

                <!-- Grid: Logo + Color -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Logo Upload -->
                    <div>
                        <label for="logo" class="block text-sm font-semibold text-gray-900 mb-2">
                            Logo de la Empresa
                        </label>
                        <div class="relative">
                            <input 
                                type="file" 
                                id="logo" 
                                name="logo"
                                accept="image/png,image/jpeg,image/jpg,image/webp,image/svg+xml"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                            >
                            <input type="hidden" id="logo_url" name="logo_url" value="">
                        </div>
                        <p class="text-gray-500 text-xs mt-1">PNG, JPG, WebP o SVG (m√°x 10MB)</p>
                        
                        <!-- Logo Preview -->
                        <div id="logoPreview" class="mt-3 hidden">
                            <img id="previewImg" src="" alt="Logo preview" class="max-h-20 rounded">
                        </div>
                        
                        <!-- Upload Progress -->
                        <div id="uploadProgress" class="mt-2 hidden">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="progressBar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                            <p class="text-xs text-gray-600 mt-1">Subiendo...</p>
                        </div>
                    </div>

                    <!-- Color Picker -->
                    <div>
                        <label for="brand_color" class="block text-sm font-semibold text-gray-900 mb-2">
                            Color Corporativo
                        </label>
                        <div class="flex gap-2">
                            <input 
                                type="color" 
                                id="brand_color" 
                                name="brand_color"
                                value="#000000"
                                class="w-20 h-10 border border-gray-300 rounded-lg cursor-pointer"
                            >
                            <input 
                                type="text" 
                                id="colorValue" 
                                placeholder="#000000"
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-sm"
                                readonly
                            >
                        </div>
                        <p class="text-gray-500 text-xs mt-1">Se utilizar√° en headers y acentos</p>
                    </div>
                </div>
            </div>

            <!-- Hidden Fields for Branding -->
            <input type="hidden" id="logoData" name="logoData" value="">

            <!-- Botones -->
            <div class="flex gap-3 pt-6 border-t border-gray-200">
                <a href="/dashboard" class="flex-1 px-4 py-2.5 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors text-center">
                    Cancelar
                </a>
                <button type="submit" class="flex-1 px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
                    Crear Propuesta
                </button>
            </div>
        </form>
    </div>

    <!-- Informaci√≥n -->
    <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-4">
        <p class="text-sm text-blue-900">
            <strong>Nota:</strong> Despu√©s de crear la propuesta podr√°s a√±adir venues, servicios y platos desde el editor.
        </p>
    </div>

</main>

<%- include('../partials/footer') %>

<script>
/**
 * Client Logo Upload & Branding Handler
 * Funcionalidades:
 * - Upload de logo con preview
 * - Sincronizaci√≥n de color picker
 * - Validaci√≥n de archivo
 */

document.addEventListener('DOMContentLoaded', function () {
  const logoInput = document.getElementById('logo');
  const brandColorInput = document.getElementById('brand_color');
  const colorValue = document.getElementById('colorValue');
  const logoUrlInput = document.getElementById('logo_url');
  const logoPreview = document.getElementById('logoPreview');
  const previewImg = document.getElementById('previewImg');
  const uploadProgress = document.getElementById('uploadProgress');
  const progressBar = document.getElementById('progressBar');
  const proposalForm = document.getElementById('proposalForm');

  // ========== Color Picker Sync ==========
  brandColorInput.addEventListener('input', function () {
    colorValue.value = this.value;
  });

  // Initialize with default color
  colorValue.value = brandColorInput.value;

  // ========== Logo Upload Handler ==========
  logoInput.addEventListener('change', async function (e) {
    const file = e.target.files[0];
    if (!file) return;

    // Validaci√≥n de tama√±o (10MB)
    const maxSizeMB = 10;
    const maxSizeBytes = maxSizeMB * 1024 * 1024;
    
    if (file.size > maxSizeBytes) {
      alert(`El archivo es demasiado grande. M√°ximo ${maxSizeMB}MB.`);
      logoInput.value = '';
      return;
    }

    // Validaci√≥n de tipo de archivo
    const allowedMimes = [
      'image/png',
      'image/jpeg',
      'image/jpg',
      'image/webp',
      'image/svg+xml'
    ];

    if (!allowedMimes.includes(file.type)) {
      alert('Tipo de archivo no permitido. Use PNG, JPG, WebP o SVG.');
      logoInput.value = '';
      return;
    }

    // Mostrar preview local mientras se procesa
    const reader = new FileReader();
    reader.onload = function (event) {
      previewImg.src = event.target.result;
      logoPreview.classList.remove('hidden');
    };
    reader.readAsDataURL(file);

    // Subir archivo
    await uploadLogo(file);
  });

  // ========== Funci√≥n de Upload ==========
  async function uploadLogo(file) {
    const formData = new FormData();
    formData.append('logo', file);

    uploadProgress.classList.remove('hidden');
    progressBar.style.width = '30%';

    try {
      const response = await fetch('/api/proposal/upload-logo', {
        method: 'POST',
        body: formData
      });

      progressBar.style.width = '80%';

      const result = await response.json();

      if (!response.ok || !result.success) {
        throw new Error(result.error || 'Error al subir logo');
      }

      // Guardar URL del logo en el formulario
      logoUrlInput.value = result.logoUrl;

      progressBar.style.width = '100%';
      setTimeout(() => {
        uploadProgress.classList.add('hidden');
        progressBar.style.width = '0%';
      }, 500);

      console.log('‚úÖ Logo subido:', result.logoUrl);
    } catch (err) {
      console.error('‚ùå Error subiendo logo:', err);
      alert(`Error: ${err.message}`);
      uploadProgress.classList.add('hidden');
      logoInput.value = '';
      logoPreview.classList.add('hidden');
      logoUrlInput.value = '';
    }
  }

  // ========== Validaci√≥n al Submit ==========
  proposalForm.addEventListener('submit', function (e) {
    // El formulario se env√≠a normalmente
    // Los valores de logo_url y brand_color ya est√°n en los inputs hidden
  });
});
</script>

</body>
</html>

