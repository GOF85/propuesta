# ğŸ—ºï¸ MICE CATERING - Route Architecture Diagram

## Request Flow Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    INCOMING HTTP REQUEST                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                     â”‚                     â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ PUBLIC ROUTES  â”‚    â”‚  AUTH CHECK â”‚    â”‚  ADMIN ONLY       â”‚
            â”‚ (No Auth)      â”‚    â”‚  REQUIRED   â”‚    â”‚  role=admin       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                    â”‚                     â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚                     â”‚
          â”‚                    â”‚        â”‚                     â”‚
      â”Œâ”€â”€â”€â–¼â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ–¼â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚/loginâ”‚   â”‚/p/:  â”‚    â”‚  â”‚  â”‚/Dashâ”‚  â”‚/Proposalsâ”‚   â”‚/admin/*  â”‚
      â”‚      â”‚   â”‚hash  â”‚    â”‚  â”‚  â”‚boardâ”‚  â”‚/CRUD    â”‚   â”‚  Panel   â”‚
      â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Complete Route Hierarchy

```
APPLICATION ROOT
â”‚
â”œâ”€â”€ AUTH LAYER (src/routes/auth.js)
â”‚   â”œâ”€â”€ GET  /login                      â†’ Login form
â”‚   â”œâ”€â”€ POST /login                      â†’ Process login â†’ Create session
â”‚   â””â”€â”€ GET  /logout                     â†’ Destroy session
â”‚
â”œâ”€â”€ DASHBOARD (src/routes/dashboard.js)
â”‚   â”œâ”€â”€ GET  /dashboard                  â†’ List proposals (DashboardController)
â”‚   â”œâ”€â”€ GET  /proposal/new               â†’ New proposal form
â”‚   â”œâ”€â”€ POST /proposal                   â†’ Create proposal (DashboardController)
â”‚   â”œâ”€â”€ POST /proposal/:id/duplicate     â†’ Clone proposal
â”‚   â”œâ”€â”€ POST /proposal/:id/delete        â†’ Delete proposal
â”‚   â”œâ”€â”€ POST /proposal/:id/status        â†’ Update status (AJAX)
â”‚   â”‚
â”‚   â””â”€â”€ ADMIN PANEL (requires admin role)
â”‚       â”œâ”€â”€ GET /admin                   â†’ Admin dashboard
â”‚       â”œâ”€â”€ GET /admin/venues            â†’ Manage venues
â”‚       â”œâ”€â”€ GET /admin/dishes            â†’ Manage dishes
â”‚       â””â”€â”€ GET /admin/services          â†’ Manage services
â”‚
â”œâ”€â”€ EDITOR (src/routes/editor.js)
â”‚   â”œâ”€â”€ GET  /proposal/:id/edit          â†’ Editor view (EditorController)
â”‚   â”œâ”€â”€ POST /proposal/:id/update        â†’ Save changes
â”‚   â”œâ”€â”€ POST /proposal/:id/publish       â†’ Send to client
â”‚   â””â”€â”€ POST /proposal/:id/archive       â†’ Archive proposal
â”‚
â”œâ”€â”€ API (src/routes/api.js)
â”‚   â”‚
â”‚   â”œâ”€â”€ SERVICES MANAGEMENT
â”‚   â”‚   â”œâ”€â”€ POST   /api/proposals/:id/services         â†’ Add service
â”‚   â”‚   â”œâ”€â”€ DELETE /api/proposals/:id/services/:svcId  â†’ Remove service
â”‚   â”‚   â”œâ”€â”€ POST   /api/proposals/:id/options          â†’ Add option
â”‚   â”‚   â”œâ”€â”€ DELETE /api/proposals/:id/options/:optId   â†’ Remove option
â”‚   â”‚   â””â”€â”€ GET    /api/proposals/:id/data             â†’ Get full data (JSON)
â”‚   â”‚
â”‚   â”œâ”€â”€ VENUE MANAGEMENT
â”‚   â”‚   â”œâ”€â”€ GET    /api/venues                         â†’ List venues (public)
â”‚   â”‚   â”œâ”€â”€ GET    /api/venues/:id                     â†’ Get venue (public)
â”‚   â”‚   â”œâ”€â”€ POST   /api/proposals/:id/venues           â†’ Add venue to proposal
â”‚   â”‚   â”œâ”€â”€ DELETE /api/proposals/:id/venues/:venueId  â†’ Remove venue
â”‚   â”‚   â”œâ”€â”€ POST   /api/admin/venues/scrape            â†’ Puppeteer scraping â­
â”‚   â”‚   â”œâ”€â”€ POST   /api/admin/venues/manual            â†’ Create manual venue
â”‚   â”‚   â”œâ”€â”€ PUT    /api/admin/venues/:id               â†’ Update venue
â”‚   â”‚   â””â”€â”€ DELETE /api/admin/venues/:id               â†’ Delete venue
â”‚   â”‚
â”‚   â”œâ”€â”€ IMAGE UPLOAD
â”‚   â”‚   â”œâ”€â”€ POST   /api/admin/upload/image             â†’ Single image (Sharp)
â”‚   â”‚   â”œâ”€â”€ POST   /api/admin/upload/logo              â†’ Logo + color extract
â”‚   â”‚   â”œâ”€â”€ POST   /api/admin/upload/batch             â†’ Multiple images
â”‚   â”‚   â””â”€â”€ DELETE /api/admin/image/:hash              â†’ Delete image
â”‚   â”‚
â”‚   â”œâ”€â”€ FINANCIAL ENGINE â­â­
â”‚   â”‚   â”œâ”€â”€ POST   /api/proposals/:id/calculate        â†’ Recalculate totals
â”‚   â”‚   â”œâ”€â”€ GET    /api/proposals/:id/totals           â†’ Get breakdown
â”‚   â”‚   â”œâ”€â”€ POST   /api/proposals/:id/discount         â†’ Apply manual discount
â”‚   â”‚   â”œâ”€â”€ DELETE /api/proposals/:id/discount         â†’ Remove discount
â”‚   â”‚   â”œâ”€â”€ GET    /api/proposals/:id/margin-analysis  â†’ Profit margins
â”‚   â”‚   â”œâ”€â”€ GET    /api/proposals/:id/audit-log        â†’ Price history
â”‚   â”‚   â”œâ”€â”€ GET    /api/volume-discounts               â†’ List tiers
â”‚   â”‚   â”œâ”€â”€ POST   /api/volume-discounts               â†’ Create tier
â”‚   â”‚   â””â”€â”€ PUT    /api/volume-discounts/:tierId       â†’ Update tier
â”‚   â”‚
â”‚   â””â”€â”€ INLINE ADMIN (src/app.js)
â”‚       â”œâ”€â”€ POST /admin/dishes/import                  â†’ CSV import
â”‚       â”œâ”€â”€ GET  /admin/dishes/export                  â†’ CSV export
â”‚       â””â”€â”€ POST /admin/dishes/:id/delete              â†’ Delete dish
â”‚
â””â”€â”€ CLIENT (src/routes/client.js) - PUBLIC VIA MAGIC LINK
    â”œâ”€â”€ GET  /p/:hash                    â†’ View proposal (magic link)
    â”œâ”€â”€ GET  /p/:hash/messages           â†’ Get messages (AJAX polling)
    â”œâ”€â”€ POST /p/:hash/messages           â†’ Send message
    â”œâ”€â”€ POST /p/:hash/messages/mark-read â†’ Mark as read
    â”œâ”€â”€ POST /p/:hash/download-pdf       â†’ Download PDF
    â”œâ”€â”€ POST /p/:hash/accept             â†’ Accept proposal
    â”œâ”€â”€ POST /p/:hash/reject             â†’ Reject proposal
    â””â”€â”€ POST /p/:hash/modifications      â†’ Request modifications
```

---

## Middleware Stack

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    1. JSON Body Parser (50MB)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. URL Encoded Parser              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. File Upload Handler (50MB max)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. Static File Server (/public)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5. Express Session (24h timeout)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 6. Flash Message System            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 7. Request Logger                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 8. Response Locals Injector        â”‚
â”‚    (user, messages, formatters)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              ROUTE HANDLERS        â”‚
â”‚    (Auth check / authorization)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 9. 404 Handler                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 10. Global Error Handler           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Authentication & Authorization Flow

```
                    REQUEST RECEIVED
                          â”‚
                          â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ Route Matched?  â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                  â”‚                  â”‚
   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚ PUBLIC â”‚      â”‚ PROTECTED  â”‚      â”‚ ADMIN   â”‚
   â”‚ (None) â”‚      â”‚ (Needs     â”‚      â”‚ (Needs  â”‚
   â”‚        â”‚      â”‚ Session)   â”‚      â”‚ Admin   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â”‚ Role)   â”‚
        â”‚                â”‚              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚           â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”            â”‚
        â”‚           â”‚ Session   â”‚       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           â”‚ Exists?   â”‚       â”‚ authenticateUser
        â”‚           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â”‚ +
        â”‚                â”‚              â”‚ authorizeRole
        â”‚           YES  â”‚   NO         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                â”‚              â”‚
        â”‚           â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”Œâ–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           â”‚ Store in  â”‚      â”‚ Role Check:    â”‚
        â”‚           â”‚ res.localsâ”‚      â”‚ admin only?    â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¤ Proceed   â”‚      â”‚ YES â†’ Proceed  â”‚
               â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ NO â†’ 403       â”‚
               â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
        HANDLER EXECUTES
               â”‚
               â”œâ”€ Validation (express-validator)
               â”‚  â””â”€ If invalid: 400 error
               â”‚
               â”œâ”€ Business Logic (Services)
               â”‚  â””â”€ If error: catch and next(err)
               â”‚
               â””â”€ Response
                  â”œâ”€ HTML (view render)
                  â”œâ”€ JSON (API)
                  â””â”€ Redirect (302/303)
```

---

## Data Flow: Proposal Editor

```
CLIENT (Browser)
      â”‚
      â”œâ”€â–¶ GET /proposal/:id/edit
      â”‚   â”œâ”€ EditorController.renderEditor()
      â”‚   â”œâ”€ ProposalService.getProposalById(id)
      â”‚   â””â”€ RENDER editor.ejs (with data embedded)
      â”‚
      â”‚â—€â”€ HTML View (editor.ejs)
      â”‚
      â”œâ”€â–¶ POST /api/proposals/:id/services (AJAX)
      â”‚   â”œâ”€ EditorController.addService()
      â”‚   â”œâ”€ DB: INSERT INTO proposal_services
      â”‚   â””â”€ RESPONSE: { success: true, service_id: 123 }
      â”‚
      â”œâ”€â–¶ POST /api/proposals/:id/calculate (AJAX)
      â”‚   â”œâ”€ EditorController.calculateTotals()
      â”‚   â”œâ”€ ProposalService.calculateTotals()
      â”‚   â”‚   â”œâ”€ SUM(price_pax * pax) per service
      â”‚   â”‚   â”œâ”€ Apply VAT (10% services, 21% food)
      â”‚   â”‚   â”œâ”€ Apply discounts
      â”‚   â”‚   â””â”€ Calculate margins
      â”‚   â””â”€ RESPONSE: { subtotal, vat, total, margin }
      â”‚
      â”œâ”€â–¶ POST /api/proposals/:id/discount (AJAX)
      â”‚   â”œâ”€ ProposalService.applyManualDiscount()
      â”‚   â”œâ”€ DB: UPDATE proposals SET discount_percentage
      â”‚   â””â”€ RESPONSE: { totals RECALCED }
      â”‚
      â””â”€â–¶ POST /proposal/:id/publish
          â”œâ”€ EditorController.publishProposal()
          â”œâ”€ ProposalService.updateProposal({ status: 'sent' })
          â”œâ”€ Generate magic hash (UUID)
          â”œâ”€ DB: INSERT INTO proposal_hashes
          â”œâ”€ EmailService.sendProposal() â† Send email to client
          â””â”€ REDIRECT /dashboard
```

---

## Data Flow: Client Proposal View (Magic Link)

```
CLIENT (External, No Auth)
      â”‚
      â”œâ”€â–¶ GET /p/:abc123def456... (magic link in email)
      â”‚   â”œâ”€ ClientController.viewProposal()
      â”‚   â”œâ”€ ProposalService.getProposalByHash(hash)
      â”‚   â”‚   â””â”€ Check: Proposal found? Not expired? Not is_editing?
      â”‚   â”‚
      â”‚   â”œâ”€ IF is_editing = TRUE
      â”‚   â”‚  â””â”€ RENDER maintenance.ejs (waiting screen)
      â”‚   â”‚
      â”‚   â””â”€ ELSE
      â”‚      â”œâ”€ Calculate totals
      â”‚      â”œâ”€ Load messages (empty array, loaded via AJAX)
      â”‚      â””â”€ RENDER proposal-view.ejs
      â”‚
      â”œâ”€â–¶ GET /p/:hash/messages (AJAX, every 30s)
      â”‚   â”œâ”€ ClientController.getMessages()
      â”‚   â”œâ”€ ChatService.getMessages(proposal_id)
      â”‚   â””â”€ RESPONSE: [{ id, sender_id, body, created_at }, ...]
      â”‚
      â”œâ”€â–¶ POST /p/:hash/messages (Send message)
      â”‚   â”œâ”€ ClientController.sendMessage()
      â”‚   â”œâ”€ ChatService.createMessage()
      â”‚   â”œâ”€ DB: INSERT INTO proposal_messages
      â”‚   â”œâ”€ EmailService.notifyProposer()
      â”‚   â””â”€ RESPONSE: { success: true }
      â”‚
      â”œâ”€â–¶ POST /p/:hash/accept
      â”‚   â”œâ”€ ClientController.acceptProposal()
      â”‚   â”œâ”€ DB: UPDATE proposals SET status='accepted'
      â”‚   â”œâ”€ EmailService.sendConfirmation()
      â”‚   â””â”€ RESPONSE: confirm screen
      â”‚
      â””â”€â–¶ POST /p/:hash/modifications
          â”œâ”€ ClientController.requestModifications()
          â”œâ”€ ChatService.createMessage() (with flag: is_modification_request)
          â”œâ”€ EmailService.notifyProposer()
          â””â”€ RESPONSE: { success: true }
```

---

## Financial Engine Flow

```
EDITOR UPDATES PROPOSAL
      â”‚
      â””â”€â–¶ Change quantity, add service, apply discount
          â”‚
          â””â”€â–¶ POST /api/proposals/:id/calculate
              â”‚
              â–¼
    ProposalService.calculateTotals(id)
              â”‚
              â”œâ”€ SELECT proposal_items, proposal_services
              â”‚
              â”œâ”€ FOR EACH service:
              â”‚  â”œâ”€ subtotal = SUM(price_pax * pax)
              â”‚  â”œâ”€ vat = subtotal * vat_rate
              â”‚  â””â”€ total = subtotal + vat
              â”‚
              â”œâ”€ APPLY volume discount (if pax > tier)
              â”‚
              â”œâ”€ APPLY manual discount (if set)
              â”‚
              â”œâ”€ CALCULATE margin:
              â”‚  â”œâ”€ cost (from dishes)
              â”‚  â”œâ”€ gross = total - cost
              â”‚  â””â”€ margin% = gross / total
              â”‚
              â”œâ”€ AUDIT LOG:
              â”‚  â””â”€ INSERT price_audit_log (reason, user_id, old_total, new_total)
              â”‚
              â””â”€ RESPONSE: { subtotal, vat, total, margin, audit_trail }

EXAMPLE CALCULATION:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Proposal: 100 pax                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Service 1: Catering (Gastronomy)                       â”‚
â”‚   Option: Menu A - 30â‚¬/pax                             â”‚
â”‚   Subtotal: 30 Ã— 100 = 3000â‚¬                          â”‚
â”‚   VAT (21%): 630â‚¬                                      â”‚
â”‚   SUBTOTAL: 3630â‚¬                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Service 2: Logistics (Staff)                           â”‚
â”‚   Waiters - 15â‚¬/pax                                    â”‚
â”‚   Subtotal: 15 Ã— 100 = 1500â‚¬                          â”‚
â”‚   VAT (10%): 150â‚¬                                      â”‚
â”‚   SUBTOTAL: 1650â‚¬                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SUBTOTAL:                             5280â‚¬            â”‚
â”‚ Manual Discount (10%):                -528â‚¬            â”‚
â”‚ TOTAL (before proof):                 4752â‚¬            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MARGIN ANALYSIS:                                       â”‚
â”‚   Cost (from dish costs):             1500â‚¬            â”‚
â”‚   Gross Profit:                       3252â‚¬            â”‚
â”‚   Margin %:                           68.4% âœ…         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Role-Based Access Control (RBAC)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Route        â”‚ Needed   â”‚ Typical   â”‚ Can Access         â”‚
â”‚              â”‚ Role     â”‚ User      â”‚                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ /login       â”‚ None     â”‚ Anyone    â”‚ âœ… All             â”‚
â”‚ /dashboard   â”‚ Session  â”‚ Commercialâ”‚ âœ… Commercial+     â”‚
â”‚ /proposal/* â”‚ Session  â”‚ Commercialâ”‚ âœ… Commercial only â”‚
â”‚              â”‚          â”‚           â”‚ (own proposals)    â”‚
â”‚ /admin/*     â”‚ Admin    â”‚ Admin     â”‚ âœ… Admin only      â”‚
â”‚ /api/admin/* â”‚ Admin    â”‚ Admin     â”‚ âœ… Admin only      â”‚
â”‚ /p/:hash     â”‚ None     â”‚ Client    â”‚ âœ… Public link     â”‚
â”‚ /api/venues  â”‚ None     â”‚ Anyone    â”‚ âœ… Public API      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Error Handling

```
Request Handler
      â”‚
      â”œâ”€â–¶ Validation Error
      â”‚   â””â”€ return res.status(400).json({...}) or .render(errors/400)
      â”‚
      â”œâ”€â–¶ Permission Error (wrong user/role)
      â”‚   â””â”€ return res.status(403).json({...}) or .render(errors/403)
      â”‚
      â”œâ”€â–¶ Not Found Error
      â”‚   â””â”€ return res.status(404).json({...}) or .render(errors/404)
      â”‚
      â””â”€â–¶ Server Error (try/catch)
          â””â”€ catch (err) â†’ next(err)
             â”‚
             â””â”€ Global Error Handler (app.use(errorHandler))
                â””â”€ return res.status(500).json({...})

Response Pattern:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
JSON Routes:
  âœ… { success: true, data: {...}, message: "..." }
  âŒ { success: false, error: "...", message: "..." }

HTML Routes:
  âœ… res.render('view', { data })
  âŒ res.status(400).render('errors/400', { message })

Redirects:
  âœ… res.redirect(302, '/dashboard')
  âŒ (implied from POST submission)
```

---

## Route Testing Checklist

```
ğŸ” When adding a new route:

â–¡ Route path correct and unique?
â–¡ HTTP method correct (GET/POST/PUT/DELETE)?
â–¡ Validation rules applied?
  â–¡ express-validator chains declared
  â–¡ All body/param/query fields validated
â–¡ Authorization middleware applied?
  â–¡ authenticateUser for protected routes
  â–¡ authorizeRole('admin') for admin routes
â–¡ Controller method exists and exported?
â–¡ Error handling in place?
  â–¡ try/catch wrapper
  â–¡ next(err) called on errors
  â–¡ Permissions checked (user_id, role)
â–¡ Response format correct?
  â–¡ JSON routes: { success, [...data] }
  â–¡ HTML routes: res.render('view', data)
  â–¡ Redirects: res.redirect(302, path)
â–¡ View template exists (if HTML)?
â–¡ Database queries optimized (prepared statements)?
â–¡ Rate limiting needed? (especially public APIs)
â–¡ Route registered in correct file?
â–¡ Route registered in correct order (app.js)?
â–¡ Works with CORS/preflight requests (if needed)?
```

---

## Quick Reference: Route Query Examples

```bash
# GET requests (with query parameters)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# List proposals with filters
GET /dashboard?status=sent&search=Google&page=1

# List venues with filters
GET /api/venues?search=madrid&minCapacity=200

# Get proposals by status
GET /dashboard?status=draft

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# POST requests (with body & params)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Create proposal
POST /proposal
{
  "client_name": "Amazon Inc",
  "event_date": "2026-03-15",
  "pax": 150
}

# Add service to proposal
POST /api/proposals/42/services
{
  "title": "Catering Buffet",
  "type": "gastronomy",
  "vat_rate": 21
}

# Apply discount
POST /api/proposals/42/discount
{
  "discount_percentage": 10,
  "reason": "Loyal client"
}

# Send proposal to client
POST /proposal/42/publish
(no body, auto-generates magic link & sends email)

# Client sends message
POST /p/abc123def456/messages
{
  "message_body": "Can we add a cocktail hour?"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# PUT requests (update existing)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Update venue
PUT /api/admin/venues/5
{
  "name": "New name",
  "capacity_banquet": 250
}

# Update volume discount tier
PUT /api/volume-discounts/3
{
  "discount_percentage": 15
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# DELETE requests
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Remove service from proposal
DELETE /api/proposals/42/services/7

# Delete proposal
POST /proposal/42/delete  (actually POST form, not true DELETE)

# Delete venue
DELETE /api/admin/venues/5

# Remove discount
DELETE /api/proposals/42/discount
```

---

## Summary

**Total Routes:** 52  
**Views:** 15+  
**Controllers:** 4  
**Services:** 5  
**Middleware:** 10+  

**Key Features:**
âœ… Magic link public access (no login required)  
âœ… Role-based access control (admin, commercial)  
âœ… Financial engine (VAT, discounts, margins)  
âœ… Image optimization (Sharp, WebP)  
âœ… Web scraping (Puppeteer)  
âœ… Email notifications (Nodemailer)  
âœ… Real-time chat (AJAX polling)  
âœ… PDF export (Puppeteer)  

**Next Phases:**
â­â­â­ User database integration  
â­â­â­ Rate limiting on magic links  
â­â­â­ Password reset flow  
â­â­ Analytics dashboard  
â­â­ Signature capture (e-signature)  

---

*Generated: February 6, 2026*  
*Architecture: Node.js/Express/MariaDB*  
*Status: Complete routing structure defined*
