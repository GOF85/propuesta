#!/usr/bin/expect -f
# Deploy fixes to production server

set timeout 60
set user "root"
set host "188.95.113.225"
set password "Kbmef9Pke9u36VHh"

puts "ğŸš€ Desplegando cambios al servidor de producciÃ³n...\n"

# Copiar ProposalService.js
puts "ğŸ“¦ Desplegando ProposalService.js..."
spawn scp -o StrictHostKeyChecking=no src/services/ProposalService.js $user@$host:/var/www/propuesta/src/services/
expect {
    "*password:" { send "$password\r" }
    "assword:" { send "$password\r" }
    timeout { puts "âŒ Timeout"; exit 1 }
}
expect eof

# Copiar editorController.js
puts "ğŸ“¦ Desplegando editorController.js..."
spawn scp -o StrictHostKeyChecking=no src/controllers/editorController.js $user@$host:/var/www/propuesta/src/controllers/
expect {
    "*password:" { send "$password\r" }
    "assword:" { send "$password\r" }
    timeout { puts "âŒ Timeout"; exit 1 }
}
expect eof

# Copiar script de test
puts "ğŸ“¦ Desplegando create-test-proposals.js..."
spawn scp -o StrictHostKeyChecking=no scripts/create-test-proposals.js $user@$host:/var/www/propuesta/scripts/
expect {
    "*password:" { send "$password\r" }
    "assword:" { send "$password\r" }
    timeout { puts "âŒ Timeout"; exit 1 }
}
expect eof

puts "\nâœ… Archivos desplegados"
puts "ğŸ”„ Reiniciando aplicaciÃ³n...\n"

# Reiniciar PM2
spawn ssh -o StrictHostKeyChecking=no $user@$host "cd /var/www/propuesta && pm2 restart propuesta-app"
expect {
    "*password:" { 
        send "$password\r"
        expect eof
    }
    "assword:" { 
        send "$password\r"
        expect eof
    }
    timeout { puts "âŒ Timeout reiniciando"; exit 1 }
}

puts "\nâœ¨ Â¡Deployment completado!"
puts "ğŸ“ Verifica: https://propuesta.micecatering.eu/dashboard\n"
